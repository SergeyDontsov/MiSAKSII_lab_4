<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –§–æ—Ä—É–º–æ–º</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-size: 0.9rem; }
        .sidebar-section { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card { border: none; border-radius: 10px; transition: 0.3s; }
        .card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .sticky-top { top: 20px; z-index: 1000; }
        .post-item { border-left: 3px solid #0d6efd; background: #fff; margin-bottom: 10px; padding: 10px; border-radius: 0 5px 5px 0; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">FORUM ENGINE</a>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#loginModal">–í—Ö–æ–¥</button>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#registerModal">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#profileModal">–ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="sticky-top">
                <div class="sidebar-section p-3 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCategoryModal">+</button>
                    </div>
                    <div class="list-group list-group-flush">
                        {% for cat in categories %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span title="{{ cat.description }}">{{ cat.name }}</span>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-link text-danger" onclick="deleteCategory('{{ cat.id }}')">‚úï</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="sidebar-section p-3">
                    <h5>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h5>
                    <div id="usersList" class="small text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div id="threadListView">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="h4">–°–ø–∏—Å–æ–∫ —Ç–µ–º</h2>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addThreadModal">+ –¢–µ–º–∞</button>
                </div>

                {% for thread in threads %}
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5 class="card-title text-primary">{{ thread.title }}</h5>
                            {% if thread.pinned %}<span class="badge bg-warning text-dark">üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ</span>{% endif %}
                        </div>
                        <p class="text-secondary">{{ thread.description }}</p>
                        <div class="d-flex flex-wrap gap-2 align-items-center border-top pt-2">
                            <small class="me-auto">–°—Ç–∞—Ç—É—Å: <b>{{ thread.status }}</b></small>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewThread('{{ thread.id }}')">–û—Ç–∫—Ä—ã—Ç—å</button>
                            <button class="btn btn-sm btn-outline-info" onclick="openMoveModal('{{ thread.id }}')">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="pinThread('{{ thread.id }}')">üìå</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteThread('{{ thread.id }}')">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div id="threadDetailView" style="display:none;">
                <button class="btn btn-sm btn-secondary mb-3" onclick="showThreadList()">‚Üê –ù–∞–∑–∞–¥</button>
                <h3 id="viewThreadTitle"></h3>
                <div id="postsContainer" class="mt-4"></div>
                <hr>
                <h5>–û—Ç–≤–µ—Ç–∏—Ç—å</h5>
                <textarea id="newPostContent" class="form-control mb-2" rows="3"></textarea>
                <button class="btn btn-primary" onclick="createPost()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h5></div>
            <div class="modal-body">
                <form onsubmit="event.preventDefault(); updateUser();">
                    <p class="text-muted small">–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</p>
                    <input type="text" id="u_login" class="form-control mb-2" placeholder="–í–∞—à –ª–æ–≥–∏–Ω" required>
                    <input type="password" id="u_old_pass" class="form-control mb-2" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" required>
                    <hr>
                    <input type="password" id="u_new_pass" class="form-control mb-2" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                    <input type="text" id="u_name" class="form-control mb-2" placeholder="–ù–æ–≤–æ–µ –∏–º—è">
                    <input type="email" id="u_email" class="form-control mb-2" placeholder="–ù–æ–≤—ã–π Email">
                    <input type="text" id="u_phone" class="form-control mb-3" placeholder="–ù–æ–≤—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω">
                    <button type="submit" class="btn btn-warning w-100">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </form>
                <hr>
                <button class="btn btn-outline-danger btn-sm w-100" onclick="deleteAccount()">–£–¥–∞–ª–∏—Ç—å –º–æ–π –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" onsubmit="event.preventDefault(); createCategory();">
            <div class="modal-header"><h5>–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</h5></div>
            <div class="modal-body">
                <input type="text" id="c_name" class="form-control mb-2" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
                <textarea id="c_desc" class="form-control" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="addThreadModal" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" onsubmit="event.preventDefault(); createThread();">
            <div class="modal-header"><h5>–°–æ–∑–¥–∞—Ç—å —Ç–µ–º—É</h5></div>
            <div class="modal-body">
                <input type="text" id="t_title" class="form-control mb-2" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" required>
                <textarea id="t_desc" class="form-control mb-2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                <select id="t_cat" class="form-select">
                    {% for cat in categories %}<option value="{{ cat.id }}">{{ cat.name }}</option>{% endfor %}
                </select>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-success">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="moveThreadModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header"><h5>–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤...</h5></div>
            <div class="modal-body">
                <input type="hidden" id="move_thread_id">
                <select id="move_cat_id" class="form-select">
                    {% for cat in categories %}<option value="{{ cat.id }}">{{ cat.name }}</option>{% endfor %}
                </select>
            </div>
            <div class="modal-footer"><button class="btn btn-primary w-100" onclick="moveThread()">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button></div>
        </div>
    </div>
</div>

<script>
    window.onload = () => { fetchUsers(); };

    async function fetchUsers() {
        const res = await fetch('/USER');
        const data = await res.json();
        document.getElementById('usersList').innerHTML = data.map(u => `<div>‚Ä¢ ${u.login}</div>`).join('');
    }

    // –†–ê–ë–û–¢–ê –° –ü–†–û–§–ò–õ–ï–ú (POST /USER –∏ DELETE /USER)
    async function updateUser() {
        const payload = {
            login: document.getElementById('u_login').value,
            old_pass: document.getElementById('u_old_pass').value,
            new_pass: document.getElementById('u_new_pass').value || null,
            name: document.getElementById('u_name').value || null,
            email: document.getElementById('u_email').value || null,
            phone: document.getElementById('u_phone').value || null
        };
        const res = await fetch('/USER', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if(res.ok) { alert('–û–±–Ω–æ–≤–ª–µ–Ω–æ!'); location.reload(); }
        else alert('–û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å.');
    }

    async function deleteAccount() {
        const login = prompt("–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω:");
        const pass = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:");
        if(login && pass) {
            const res = await fetch(`/USER?login=${login}&Password=${pass}`, { method: 'DELETE' });
            if(res.ok) { alert('–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª–µ–Ω'); location.reload(); }
            else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
    }

    // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ò –í–•–û–î
    async function login() {
        const l = document.getElementById('l_login').value;
        const p = document.getElementById('l_pass').value;
        const res = await fetch(`/USER/login?Login=${l}&Password=${p}`);
        if(res.ok) { alert('–£—Å–ø–µ—à–Ω–æ!'); location.reload(); }
        else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å');
    }

    async function register() {
        const data = {
            login: document.getElementById('r_login').value,
            password: document.getElementById('r_pass').value,
            name: document.getElementById('r_name').value || "User",
            phone: document.getElementById('r_phone').value || "",
            email: document.getElementById('r_email').value || ""
        };
        const res = await fetch('/USER', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if(res.ok) location.reload();
    }

    // –¢–ï–ú–´ –ò –ü–û–°–¢–´
    let currentThreadId = null;

    async function viewThread(id) {
        currentThreadId = id;
        const res = await fetch(`/THREAD/${id}`);
        const thread = await res.json();
        document.getElementById('threadListView').style.display = 'none';
        document.getElementById('threadDetailView').style.display = 'block';
        document.getElementById('viewThreadTitle').innerText = thread.title;
        const postsHtml = thread.Posts.map(p => `
            <div class="post-item shadow-sm">
                <div class="d-flex justify-content-between small text-muted">
                    <span>–ê–≤—Ç–æ—Ä ID: ${p.author_id} | ${p.date}</span>
                    <button class="btn btn-sm text-danger" onclick="deletePost('${p.id}')">üóëÔ∏è</button>
                </div>
                <div class="mt-2">${p.content}</div>
            </div>`).join('');
        document.getElementById('postsContainer').innerHTML = postsHtml || '–°–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç';
    }

    function showThreadList() {
        document.getElementById('threadListView').style.display = 'block';
        document.getElementById('threadDetailView').style.display = 'none';
    }

    async function createPost() {
        const content = document.getElementById('newPostContent').value;
        await fetch(`/THREAD/${currentThreadId}/POSTS`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ content })
        });
        document.getElementById('newPostContent').value = '';
        viewThread(currentThreadId);
    }

    async function deletePost(id) {
        await fetch(`/POST/${id}`, { method: 'DELETE' });
        viewThread(currentThreadId);
    }

    // –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ï–ú–ê–ú–ò –ò –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò
    async function createCategory() {
        await fetch('/CATEGORY', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: document.getElementById('c_name').value, description: document.getElementById('c_desc').value })
        });
        location.reload();
    }

    async function deleteCategory(id) {
        if(confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) { await fetch(`/CATEGORY/${id}`, { method: 'DELETE' }); location.reload(); }
    }

    async function createThread() {
        const data = {
            title: document.getElementById('t_title').value,
            description: document.getElementById('t_desc').value,
            category_id: parseInt(document.getElementById('t_cat').value)
        };
        await fetch('/THREAD', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        location.reload();
    }

    async function deleteThread(id) {
        if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É?')) { await fetch(`/THREAD/${id}`, { method: 'DELETE' }); location.reload(); }
    }

    async function pinThread(id) {
        await fetch(`/THREAD/${id}/pin`, { method: 'PUT' });
        location.reload();
    }

    function openMoveModal(id) {
        document.getElementById('move_thread_id').value = id;
        new bootstrap.Modal(document.getElementById('moveThreadModal')).show();
    }

    async function moveThread() {
        const id = document.getElementById('move_thread_id').value;
        const catId = document.getElementById('move_cat_id').value;
        await fetch(`/THREAD/${id}/move`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ category_id: parseInt(catId) })
        });
        location.reload();
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>